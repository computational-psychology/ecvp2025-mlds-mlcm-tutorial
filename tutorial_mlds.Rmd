---
title: "MLDS tutorial"
author: "Guillermo Aguilar"
date: "2025-08-06"
output:
  html_notebook: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(MLDS)
```

## Analysis of an MLDS experiment

Text here explaning

### 1. Loading and parsing data

```{r}
# Loading a single file
#fname <- 'data/CH.csv'
fname <- 'data/GA.csv'

df <- read.csv(fname)
df
```

We can also load the single runs and concatenate them here in R

```{r}
# Loading multiple files
#fname1 <- 'data/GA1.csv'
#fname2 <- 'data/GA2.csv'
#fname3 <- 'data/GA3.csv'
#df1 <- read.csv(fname1)
#df2 <- read.csv(fname2)
#df3 <- read.csv(fname3)
#df <- rbind(df1, df2, df3)
#df
```

We keep only the relevant columns
```{r}
df <- df[c('resp.keys', 's1', 's2', 's3')]
df
```


### Parse data to MLDS format

We need to map the key presses to 0 or 1
```{r}
df$resp <- as.numeric(df$resp.keys == 'left')
df
```
and remove NaNs entered by Psychopy

```{r}
df <- na.omit(df)
df
```

```{r}
stim_vector <- c(5, 10, 15, 20, 25, 33, 40, 50, 60)
#stim_vector <- c(10, 15, 20, 25, 50, 75, 100, 150, 200)
stim_index <- seq(length(stim_vector))


for (i in 1:length(stim_vector)) {
  df$s1 <- replace(df$s1, df$s1==stim_vector[i], stim_index[i])
  df$s2 <- replace(df$s2, df$s2==stim_vector[i], stim_index[i])
  df$s3 <- replace(df$s3, df$s3==stim_vector[i], stim_index[i])
}


data <- df[c('resp', 's1', 's2', 's3')]
colnames(data) <- c("Resp", "S1", "S2", "S3")


data
```

### 2. Estimating perceptual scale 

Here we use the functions from the MLDS package.


```{r}
data <- as.mlbs.df(data, stim_vector)
```

```{r}
scale <- mlds(data)
scale
```

```{r}
par(pty="s")
plot(scale, xlab = "Number of dots", ylab = "Perceived numerosity")
lines(c(min(scale$stimulus), max(scale$stimulus)), c(0, max(scale$pscale)), type = "l", lty = 1)
```
```{r}
# saving plot as PDF
pdf(file = "figs/scale.pdf",   # The directory you want to save the file in
    width = 4,          # The width of the plot in inches
    height = 4)         # The height of the plot in inches
par(pty="s")
plot(scale, xlab = "Number of dots", ylab = "Perceived numerosity")
lines(c(min(scale$stimulus), max(scale$stimulus)), c(0, max(scale$pscale)), type = "l", lty = 1)
dev.off()
```

```{r}
# saving plot as PDF
pdf(file = "figs/scale_standard.pdf",   # The directory you want to save the file in
    width = 4,          # The width of the plot in inches
    height = 4)         # The height of the plot in inches
par(pty="s")
plot(scale, xlab = "Number of dots", ylab = "Perceived numerosity", standard.scale = TRUE)
lines(c(min(scale$stimulus), max(scale$stimulus)), c(0, 1), type = "l", lty = 1)
dev.off()
```


### 3. Confidence intervals and goodness of fit

#### Confidence intervals

```{r  warning=FALSE}
scale.boot <- boot.mlds(scale, nsim=1000)
scale.bt.res <- summary(scale.boot)

```

```{r}
scale.bt.mns <- scale.bt.res[, 1] # bootstrap mean
scale.bt.95ci <- qnorm(0.975) * scale.bt.res[, 2] # 95 CI

par(pty="s")
plot(scale, xlab = "Number of dots", ylab = "Perceived numerosity", standard.scale = TRUE)
segments(scale$stimulus, scale.bt.mns + scale.bt.95ci, 
         scale$stimulus, scale.bt.mns - scale.bt.95ci, )
lines(c(min(scale$stimulus), max(scale$stimulus)), c(0, 1), type = "l", lty = 1)

```


```{r}
# saving plot as PDF
pdf(file = "figs/scale_with_CI.pdf",   # The directory you want to save the file in
    width = 4,          # The width of the plot in inches
    height = 4)         # The height of the plot in inches

par(pty="s")
plot(scale, xlab = "Number of dots", ylab = "Perceived numerosity", standard.scale = TRUE)
segments(scale$stimulus, scale.bt.mns + scale.bt.95ci, 
         scale$stimulus, scale.bt.mns - scale.bt.95ci, )
lines(c(min(scale$stimulus), max(scale$stimulus)), c(0, 1), type = "l", lty = 1)
dev.off()
```
#### Goodness of fit evaluation


```{r  warning=FALSE}
scale.gof <- binom.diagnostics(scale)
```

```{r  warning=FALSE}
plot(scale.gof)
```
```{r}
# saving plot as PDF
pdf(file = "figs/gof.pdf",   # The directory you want to save the file in
    width = 8,          # The width of the plot in inches
    height = 4)         # The height of the plot in inches

plot(scale.gof)
dev.off()
```